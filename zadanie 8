-- 1. Pełny adres klientów z Polski
SELECT adres, okreg, miasto, kod_pocztowy, kraj
FROM (
    SELECT adres.adres, adres.okreg, miasto.miasto, adres.kod_pocztowy, kraj.kraj
    FROM adres 
    JOIN miasto ON adres.miasto_id = miasto.miasto_id
    JOIN kraj ON miasto.kraj_id = kraj.kraj_id
) AS pelne_adresy
WHERE kraj = 'Poland';

-- 2. Lista klientów z okręgu Texas
SELECT klient.imie, klient.nazwisko, klient.email
FROM klient 
WHERE klient.adres_id IN (
    SELECT adres_id
    FROM adres
    WHERE okreg = 'Texas'

-- 3 Napisz podzapytanie, które znajdzie identyfikator kraju United States. Używając tego podzapytania napisz kolejne podzapytanie, które zwróci identyfikatory wszystkich miast leżących w tym kraju. Używając poprzedniego podzapytania napisz podzapytanie zwracające wszystkie identyfikatory wszystkich adresów znajdujących się w tych miastach. Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę klientów mieszkających pod wybranymi adresami. W efekcie powinniśmy otrzymać listę klientów zamieszkałych w Stanach Zjednoczonych.
	SELECT klient.klient_id, klient.imie, klient.nazwisko
    FROM klient
    WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
				FROM miasto
				WHERE miasto.kraj_id IN (SELECT kraj.kraj_id
					FROM kraj
					WHERE kraj.kraj = "United State")));

-- 4 Wzorując się na poprzednim zadaniu napisz zapytanie pokazujące kwoty z tabeli płatność dla klientów z miasta London.
SELECT platnosc.platnosc_id, platnosc.kwota
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 5 Na podstawie danych z poprzedniego zadania napisz zapytanie zwracające sumę kwot klientów z miasta London.
SELECT SUM(platnosc.kwota), platnosc.platnosc_id
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 6 Napisz:
-- podzapytanie grupujące obliczające ilość adresów znajdujących się w każdym mieście – zapytanie powinno zwrócić z tabeli adres pola: miasto_id oraz count(*) as ile.
-- Używając klauzuli HAVING dopisz do poprzedniego podzapytania warunek na ile>1
-- Napisz podzapytanie wybierające z poprzedniego podzapytania tylko pole miasto_id.
-- Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę miast, w których ilość adresów jest większa niż 1.
SELECT miasto.miasto, miasto.miasto_id
FROM miasto 
WHERE miasto.miasto_id IN (
    SELECT miasto_id
    FROM (
        SELECT miasto_id, COUNT(*) AS ile
        FROM adres
        GROUP BY miasto_id
        HAVING ile > 1
    ) AS miasta_wiele_adresow

-- 7 Na podstawie poprzedniego zadania napisz zapytanie zwracające sumę kwot (tabela platnosc) z miast, w których ilość adresów jest większa niż 1.

SELECT SUM(platnosc.kwota) AS suma_platnosci
FROM platnosc 
WHERE platnosc.klient_id IN (
    SELECT klient.klient_id
    FROM klient 
    WHERE klient.adres_id IN (
        SELECT adres.adres_id
        FROM adres 
        WHERE adres.miasto_id IN (
            SELECT miasto_id
            FROM (
                SELECT miasto_id, COUNT(*) AS ile
                FROM adres
                GROUP BY miasto_id
                HAVING ile > 1
            ) AS miasta_wiele
        )
    )
);

-- 8 Wzorując się na zadaniu 6 napisz zapytanie, które za pomocą podzapytań pokaże listę aktorów grających w więcej niż 20 filmach.

SELECT aktor.imie, aktor.nazwisko, COUNT(film.film_id) AS liczba_filmow
FROM aktor 
JOIN film_aktor ON aktor.aktor_id = film.aktor_id
WHERE aktor.aktor_id IN (
    SELECT aktor_id
    FROM (
        SELECT film.aktor_id, COUNT(film.film_id) AS ile_filmow
        FROM film_aktor
        GROUP BY aktor_id
        HAVING COUNT(film_id) > 20
    ) AS aktywni_aktorzy
)
GROUP BY aktor.aktor_id, aktor.imie, aktor.nazwisko;

-- 9 Używając podzapytań wypisz listę filmów należących do kategorii: Akcja.

SELECT film.tytul, film.film_id
FROM film 
WHERE film.film_id IN (
    SELECT film_kategoria.film_id
    FROM film_kategoria 
    WHERE film_kategoria.kategoria_id = (
        SELECT film_kategoria
        FROM kategoria
        WHERE nazwa = 'Akcja'
    )
);

-- 10 Napisz zapytanie zwracające listę klientów, z krajów w których liczba klientów przekracza 10.
-- Napisz podzapytanie pokazujące listę kraj_id dla każdego adresu, zapytanie powinno zwracać adres_id i kraj_id,
-- Na podstawie danych zwróconych przez poprzednie podzapytanie napisz podzapytanie zwracające ilość adresów dla każdego kraj_id. Zapytanie powinno zwracać: kraj_id i count(adres_id) AS ile,
-- Do poprzedniego zapytania dopisz klauzulę HAVING ile>10,
-- Napisz zapytanie łączące tabele: klient, adres miasto, kraj i poprzednie podzapytanie zwracające listę klientów z krajów, w których liczba klientów przekracza 10

SELECT klient.imie, klient.nazwisko, kraj.kraj
FROM klient 
JOIN adres ON klient.adres_id = adres.adres_id
JOIN miasto ON adres.miasto_id = miasto.miasto_id
JOIN kraj ON miasto.kraj_id = kraj.kraj_id
JOIN (
    SELECT kraj_id
    FROM (
        SELECT kraj_id, COUNT(adres_id) AS ile
        FROM (
            SELECT adres.adres_id, miasto.kraj_id
            FROM adres 
            JOIN miasto miasto ON adres.miasto_id = miasto.miasto_id
        ) AS adresy_kraje
        GROUP BY kraj_id
        HAVING ile > 10
    ) AS popularne_kraje
) AS pk ON kraj.kraj_id = pk.kraj_id;
    
-- 11 Wzorując się na zadaniu 10 napisz zapytanie zwracające listę filmów, które wypożyczono więcej niż 10 razy.

SELECT film.tytul, COUNT(wypozyczenie.wypozyczenie_id) AS liczba_wypozyczen
FROM film
JOIN spis ON film.film_id = spis.film_id
JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
WHERE film.film_id IN (
    SELECT film_id
    FROM (
        SELECT spis.film_id, COUNT(wypozyczenie.wypozyczenie_id) AS ile_razy
        FROM spis
        JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
        GROUP BY spis.film_id
        HAVING ile_razy > 10
    ) AS popularne_filmy
)
GROUP BY film.film_id, film.tytul;

-- 12 Na podstawie zapytania 11 wypisz dla każdego filmu zsumowane płatności filmów, które wypożyczono więcej niż 10 razy.

SELECT film.tytul, SUM(platnosc.kwota) AS suma_platnosci
FROM film
JOIN spis ON film.film_id = spis.film_id
JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
JOIN platnosc ON wypozyczenie.wypozyczenie_id = platnosc.wypozyczenie_id
WHERE film.film_id IN (
    SELECT film_id
    FROM (
        SELECT spis.film_id, COUNT(wypozyczenie.wypozyczenie_id) AS ile
        FROM spis
        JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
        GROUP BY spis.film_id
        HAVING ile > 10
    ) AS popularne
)
GROUP BY film.film_id, film.tytul;

-- 13 Używając podzapytań napisz zapytanie zwracające listę kategorii wraz z liczbą filmów w danej kategorii:

SELECT kategorie.nazwa, liczby.ile
FROM (
    SELECT kategoria_id, nazwa
    FROM kategoria
) AS kategorie
JOIN (
    SELECT kategoria_id, COUNT(film_kategoria.film_id) AS ile
    FROM film_kategoria
    GROUP BY kategoria_id
) AS liczby ON kategorie.kategoria_id = liczby.kategoria_id;

-- 14 Używając podzapytań i złączeń napisz zapytanie zwracające sumę kwot płatności z każdej kategorii.

SELECT kategoria.nazwa AS kategoria, SUM(platnosc.kwota) AS suma_platnosci
FROM kategoria
JOIN film_kategoria ON kategoria.kategoria_id = film_kategoria.kategoria_id
JOIN film ON film_kategoria.film_id = film.film_id
JOIN spis ON film.film_id = spis.film_id
JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
JOIN platnosc ON wypozyczenie.wypozyczenie_id = platnosc.wypozyczenie_id
GROUP BY kategoria.kategoria_id, kategoria.nazwa;

-- 15 Używając podzapytań i złączeń napisz zapytanie zwracające informację o tym ile filmów z każdej kategorii było wypożyczanych w każdym kraju. Zestawienie powinno zawierać następujące pola: nazwa kraju, nazwa kategorii, ilość filmów.

SELECT kraj.kraj, kraj.kraj AS kategoria, COUNT(DISTINCT film.film_id) AS liczba_filmow
FROM kraj
JOIN miasto ON kraj.kraj_id = miasto.kraj_id
JOIN adres ON miasto.miasto_id = adres.miasto_id
JOIN klient ON adres.adres_id = klient.adres_id
JOIN wypozyczenie ON klient.klient_id = wypozyczenie.klient_id
JOIN spis ON wypozyczenie.spis_id = spis.spis_id
JOIN film ON spis.film_id = film.film_id
JOIN film_kategoria ON film.film_id = film_kategoria.film_id
JOIN kategoria ON film_kategoria.kategoria_id = kategoria.kategoria_id
GROUP BY kraj.kraj_id, kraj.kraj, kategoria.kategoria_id, kategoria.nazwa;

-- 16 Używając podzapytań i złączeń napisz zapytanie zwracające informację o tym jaka była suma kwot płatności filmów z każdej kategorii w każdym kraju. Zestawienie powinno zawierać następujące pola: nazwa kraju, nazwa kategorii, suma kwoty płatności.

SELECT kraj.kraj, kategoria.nazwa AS kategoria, SUM(platnosc.kwota) AS suma_platnosci
FROM kraj
JOIN miasto ON kraj.kraj_id = miasto.kraj_id
JOIN adres  ON miasto.miasto_id = adres.miasto_id
JOIN klient ON adres.adres_id = klient.adres_id
JOIN platnosc ON klient.klient_id = platnosc.klient_id
JOIN wypozyczenie ON platnosc.wypozyczenie_id = wypozyczenie.wypozyczenie_id
JOIN spis ON wypozyczenie.spis_id = spis.spis_id
JOIN film ON spis.film_id = film.film_id
JOIN film_kategoria ON film.film_id = film_kategoria.film_id
JOIN kategoria ON film_kategoria.kategoria_id = kategoria.kategoria_id
GROUP BY kraj.kraj_id, kraj.kraj, kategoria.kategoria_id, kategoria.nazwa;

-- 17 Używając podzapytań i złączeń napisz zapytanie zwracające ilość filmów wypożyczonych przez każdy ze sklepów w każdym z krajów. Zestawienie powinno zawierać: pełny adres sklepu, nazwę kraju i ilość wypożyczeń.

SELECT CONCAT(adres.adres, ', ', adres.okreg, ', ', miasto.miasto) AS pelny_adres_sklepu, kraj.kraj, COUNT(wypozyczenie.wypozyczenie_id) AS liczba_wypozyczen
FROM sklep
JOIN adres ON sklep.adres_id = adres.adres_id
JOIN miasto ON adres.miasto_id = miasto.miasto_id
JOIN kraj ON miasto.kraj_id = kraj.kraj_id
JOIN spis ON sklep.sklep_id = spis.sklep_id
JOIN wypozyczenie ON spis.spis_id = wypozyczenie.spis_id
GROUP BY sklep.sklep_id, adres.adres, adres.okreg, miasto.miasto, kraj.kraj;

-- 18. Suma płatności per sklep per kraj
SELECT CONCAT(a.adres, ', ', a.okreg, ', ', m.miasto) AS pelny_adres_sklepu, kr.kraj, SUM(p.kwota) AS suma_platnosci
FROM sklep sk
JOIN adres a ON sk.adres_id = a.adres_id
JOIN miasto m ON a.miasto_id = m.miasto_id
JOIN kraj kr ON m.kraj_id = kr.kraj_id
JOIN spis s ON sk.sklep_id = s.sklep_id
JOIN wypozyczenie w ON s.spis_id = w.spis_id
JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
GROUP BY sk.sklep_id, a.adres, a.okreg, m.miasto, kr.kraj;

-- 19. Suma długości filmów w kategorii
SELECT k.nazwa AS kategoria, SUM(f.dlugosc) AS suma_dlugosci_minut
FROM kategoria k
JOIN film_kategoria fk ON k.kategoria_id = fk.kategoria_id
JOIN film f ON fk.film_id = f.film_id
GROUP BY k.kategoria_id, k.nazwa;

-- 20. Jak często klient ogląda danego aktora
SELECT CONCAT(kl.imie, ' ', kl.nazwisko) AS klient, CONCAT(a.imie, ' ', a.nazwisko) AS aktor, COUNT(DISTINCT w.wypozyczenie_id) AS liczba_obejrzan
FROM klient kl
JOIN wypozyczenie w ON kl.klient_id = w.klient_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
JOIN film_aktor fa ON f.film_id = fa.film_id
JOIN aktor a ON fa.aktor_id = a.aktor_id
GROUP BY kl.klient_id, kl.imie, kl.nazwisko, a.aktor_id, a.imie, a.nazwisko;

-- 21. Jak często klient ogląda filmy z danej kategorii wiekowej
SELECT CONCAT(k.imie, ' ', k.nazwisko) AS klient, f.ocena AS kategoria_wiekowa, COUNT(w.wypozyczenie_id) AS liczba_obejrzan
FROM klient k
JOIN wypozyczenie w ON k.klient_id = w.klient_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
GROUP BY k.klient_id, k.imie, k.nazwisko, f.ocena;

-- 22. Stwórz tabelę film_akcja i wypełnij filmami kategorii Akcja
CREATE TABLE film_akcja LIKE film;

INSERT INTO film_akcja
SELECT f.*
FROM film f
WHERE f.film_id IN (
    SELECT fc.film_id
    FROM film_kategoria fc
    WHERE fc.kategoria_id = (
        SELECT kategoria_id
        FROM kategoria
        WHERE nazwa = 'Akcja'
    )
);

-- 23. Zwiększ koszty wymiany < średniej do średniej
UPDATE film_akcja
SET koszty_wymiany = (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp
)
WHERE koszty_wymiany < (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp2
);

-- 24. Zwiększ o 10% koszty wymiany < średniej
UPDATE film_akcja
SET koszty_wymiany = koszty_wymiany * 1.10
WHERE koszty_wymiany < (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp
);

-- 25. Zwiększ o 10% stawki wypożyczenia dla filmów >120 minut
UPDATE film_akcja
SET stawka_wypozycz = stawka_wypozycz * 1.10
WHERE dlugosc > 120;

-- 26. Zmniejsz o 20% stawki dla filmów z JOHNNY LOLLOBRIGIDA lub ZERO CAGE
UPDATE film_akcja
SET stawka_wypozycz = stawka_wypozycz * 0.80
WHERE film_id IN (
    SELECT DISTINCT fa.film_id
    FROM film_aktor fa
    JOIN aktor a ON fa.aktor_id = a.aktor_id
    WHERE (a.imie = 'JOHNNY' AND a.nazwisko = 'LOLLOBRIGIDA')
       OR (a.imie = 'ZERO' AND a.nazwisko = 'CAGE')
);

-- 27. Zwiększ o 20% stawki filmów z sumą płatności > średniej
UPDATE film_akcja fa
SET fa.stawka_wypozycz = fa.stawka_wypozycz * 1.20
WHERE fa.film_id IN (
    SELECT film_id
    FROM (
        SELECT f.film_id, SUM(p.kwota) AS suma_platnosci
        FROM film f
        JOIN film_kategoria fk ON f.film_id = fk.film_id
        JOIN kategoria k ON fk.kategoria_id = k.kategoria_id
        JOIN spis s ON f.film_id = s.film_id
        JOIN wypozyczenie w ON s.spis_id = w.spis_id
        JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
        WHERE k.nazwa = 'Akcja'
        GROUP BY f.film_id
        HAVING suma_platnosci > (
            SELECT AVG(sumy.suma)
            FROM (
                SELECT SUM(p2.kwota) AS suma
                FROM film f2
                JOIN film_kategoria fk2 ON f2.film_id = fk2.film_id
                JOIN kategoria k2 ON fk2.kategoria_id = k2.kategoria_id
                JOIN spis s2 ON f2.film_id = s2.film_id
                JOIN wypozyczenie w2 ON s2.spis_id = w2.spis_id
                JOIN platnosc p2 ON w2.wypozyczenie_id = p2.wypozyczenie_id
                WHERE k2.nazwa = 'Akcja'
                GROUP BY f2.film_id
            ) AS sumy
        )
    ) AS filmy_powyzej_sredniej
);

-- 28. Usuń filmy z aktorką PENELOPE GUINESS
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT DISTINCT fa.film_id
    FROM film_aktor fa
    JOIN aktor a ON fa.aktor_id = a.aktor_id
    WHERE a.imie = 'PENELOPE' AND a.nazwisko = 'GUINESS'
);

-- 29. Usuń filmy wypożyczone <3 razy
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT film_id
    FROM (
        SELECT f.film_id, COUNT(w.wypozyczenie_id) AS liczba_wypozyczen
        FROM film f
        LEFT JOIN spis s ON f.film_id = s.film_id
        LEFT JOIN wypozyczenie w ON s.spis_id = w.spis_id
        GROUP BY f.film_id
        HAVING liczba_wypozyczen < 3
    ) AS rzadko_wypozyczane
);

-- 30. Usuń filmy ze słowem "Epic" w opisie
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT film_id
    FROM film_opis
    WHERE opis LIKE '%Epic%'
);

-- 31. Usuń filmy dla dorosłych (NC-17 i PG)
DELETE FROM film_akcja
WHERE ocena IN ('NC-17', 'PG');

-- 32. Usuń tabelę film_akcja
DROP TABLE IF EXISTS film_akcja;
