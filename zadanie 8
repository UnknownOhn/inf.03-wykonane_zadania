-- 1. Pełny adres klientów z Polski
SELECT adres, okreg, miasto, kod_pocztowy, kraj
FROM (
    SELECT adres.adres, adres.okreg, miasto.miasto, adres.kod_pocztowy, kraj.kraj
    FROM adres 
    JOIN miasto ON adres.miasto_id = miasto.miasto_id
    JOIN kraj ON miasto.kraj_id = kraj.kraj_id
) AS pelne_adresy
WHERE kraj = 'Poland';

-- 2. Lista klientów z okręgu Texas
SELECT klient.imie, klient.nazwisko, klient.email
FROM klient 
WHERE klient.adres_id IN (
    SELECT adres_id
    FROM adres
    WHERE okreg = 'Texas'

-- 3 Napisz podzapytanie, które znajdzie identyfikator kraju United States. Używając tego podzapytania napisz kolejne podzapytanie, które zwróci identyfikatory wszystkich miast leżących w tym kraju. Używając poprzedniego podzapytania napisz podzapytanie zwracające wszystkie identyfikatory wszystkich adresów znajdujących się w tych miastach. Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę klientów mieszkających pod wybranymi adresami. W efekcie powinniśmy otrzymać listę klientów zamieszkałych w Stanach Zjednoczonych.
	SELECT klient.klient_id, klient.imie, klient.nazwisko
    FROM klient
    WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
				FROM miasto
				WHERE miasto.kraj_id IN (SELECT kraj.kraj_id
					FROM kraj
					WHERE kraj.kraj = "United State")));

-- 4 Wzorując się na poprzednim zadaniu napisz zapytanie pokazujące kwoty z tabeli płatność dla klientów z miasta London.
SELECT platnosc.platnosc_id, platnosc.kwota
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 5 Na podstawie danych z poprzedniego zadania napisz zapytanie zwracające sumę kwot klientów z miasta London.
SELECT SUM(platnosc.kwota), platnosc.platnosc_id
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 6 Napisz:
-- podzapytanie grupujące obliczające ilość adresów znajdujących się w każdym mieście – zapytanie powinno zwrócić z tabeli adres pola: miasto_id oraz count(*) as ile.
-- Używając klauzuli HAVING dopisz do poprzedniego podzapytania warunek na ile>1
-- Napisz podzapytanie wybierające z poprzedniego podzapytania tylko pole miasto_id.
-- Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę miast, w których ilość adresów jest większa niż 1.
SELECT m.miasto, m.miasto_id
FROM miasto m
WHERE m.miasto_id IN (
    SELECT miasto_id
    FROM (
        SELECT miasto_id, COUNT(*) AS ile
        FROM adres
        GROUP BY miasto_id
        HAVING ile > 1
    ) AS miasta_wiele_adresow

-- 7
SELECT SUM(p.kwota) AS suma_platnosci
FROM platnosc p
WHERE p.klient_id IN (
    SELECT k.klient_id
    FROM klient k
    WHERE k.adres_id IN (
        SELECT a.adres_id
        FROM adres a
        WHERE a.miasto_id IN (
            SELECT miasto_id
            FROM (
                SELECT miasto_id, COUNT(*) AS ile
                FROM adres
                GROUP BY miasto_id
                HAVING ile > 1
            ) AS miasta_wiele
        )
    )
);

-- 8
SELECT a.imie, a.nazwisko, COUNT(fa.film_id) AS liczba_filmow
FROM aktor a
JOIN film_aktor fa ON a.aktor_id = fa.aktor_id
WHERE a.aktor_id IN (
    SELECT aktor_id
    FROM (
        SELECT aktor_id, COUNT(film_id) AS ile_filmow
        FROM film_aktor
        GROUP BY aktor_id
        HAVING COUNT(film_id) > 20
    ) AS aktywni_aktorzy
)
GROUP BY a.aktor_id, a.imie, a.nazwisko;

-- 9
SELECT f.tytul, f.film_id
FROM film f
WHERE f.film_id IN (
    SELECT fc.film_id
    FROM film_kategoria fc
    WHERE fc.kategoria_id = (
        SELECT kategoria_id
        FROM kategoria
        WHERE nazwa = 'Akcja'
    )
);

-- 10
SELECT k.imie, k.nazwisko, kr.kraj
FROM klient k
JOIN adres a ON k.adres_id = a.adres_id
JOIN miasto m ON a.miasto_id = m.miasto_id
JOIN kraj kr ON m.kraj_id = kr.kraj_id
JOIN (
    SELECT kraj_id
    FROM (
        SELECT kraj_id, COUNT(adres_id) AS ile
        FROM (
            SELECT a.adres_id, m.kraj_id
            FROM adres a
            JOIN miasto m ON a.miasto_id = m.miasto_id
        ) AS adresy_kraje
        GROUP BY kraj_id
        HAVING ile > 10
    ) AS popularne_kraje
) AS pk ON kr.kraj_id = pk.kraj_id;
