-- 1. Pełny adres klientów z Polski
SELECT adres, okreg, miasto, kod_pocztowy, kraj
FROM (
    SELECT a.adres, a.okreg, m.miasto, a.kod_pocztowy, k.kraj
    FROM adres a
    JOIN miasto m ON a.miasto_id = m.miasto_id
    JOIN kraj k ON m.kraj_id = k.kraj_id
) AS pelne_adresy
WHERE kraj = 'Poland';

-- 2. Lista klientów z okręgu Texas
SELECT k.imie, k.nazwisko, k.email
FROM klient k
WHERE k.adres_id IN (
    SELECT adres_id
    FROM adres
    WHERE okreg = 'Texas'

-- 3 Napisz podzapytanie, które znajdzie identyfikator kraju United States. Używając tego podzapytania napisz kolejne podzapytanie, które zwróci identyfikatory wszystkich miast leżących w tym kraju. Używając poprzedniego podzapytania napisz podzapytanie zwracające wszystkie identyfikatory wszystkich adresów znajdujących się w tych miastach. Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę klientów mieszkających pod wybranymi adresami. W efekcie powinniśmy otrzymać listę klientów zamieszkałych w Stanach Zjednoczonych.
	SELECT klient.klient_id, klient.imie, klient.nazwisko
    FROM klient
    WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
				FROM miasto
				WHERE miasto.kraj_id IN (SELECT kraj.kraj_id
					FROM kraj
					WHERE kraj.kraj = "United State")));

-- 4 Wzorując się na poprzednim zadaniu napisz zapytanie pokazujące kwoty z tabeli płatność dla klientów z miasta London.
SELECT platnosc.platnosc_id, platnosc.kwota
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 5 Na podstawie danych z poprzedniego zadania napisz zapytanie zwracające sumę kwot klientów z miasta London.
SELECT SUM(platnosc.kwota), platnosc.platnosc_id
FROM platnosc
WHERE platnosc.klient_id IN (SELECT klient.klient_id
        FROM klient
        WHERE klient.adres_id IN (SELECT adres.adres_id
			FROM adres
			WHERE adres.miasto_id IN (SELECT miasto.miasto_id
					FROM miasto
					WHERE miasto.miasto = "London")));

-- 6 Napisz:
-- podzapytanie grupujące obliczające ilość adresów znajdujących się w każdym mieście – zapytanie powinno zwrócić z tabeli adres pola: miasto_id oraz count(*) as ile.
-- Używając klauzuli HAVING dopisz do poprzedniego podzapytania warunek na ile>1
-- Napisz podzapytanie wybierające z poprzedniego podzapytania tylko pole miasto_id.
-- Na podstawie poprzedniego podzapytania napisz zapytanie zwracające listę miast, w których ilość adresów jest większa niż 1.
SELECT m.miasto, m.miasto_id
FROM miasto m
WHERE m.miasto_id IN (
    SELECT miasto_id
    FROM (
        SELECT miasto_id, COUNT(*) AS ile
        FROM adres
        GROUP BY miasto_id
        HAVING ile > 1
    ) AS miasta_wiele_adresow

-- 7
SELECT SUM(p.kwota) AS suma_platnosci
FROM platnosc p
WHERE p.klient_id IN (
    SELECT k.klient_id
    FROM klient k
    WHERE k.adres_id IN (
        SELECT a.adres_id
        FROM adres a
        WHERE a.miasto_id IN (
            SELECT miasto_id
            FROM (
                SELECT miasto_id, COUNT(*) AS ile
                FROM adres
                GROUP BY miasto_id
                HAVING ile > 1
            ) AS miasta_wiele
        )
    )
);

-- 8
SELECT a.imie, a.nazwisko, COUNT(fa.film_id) AS liczba_filmow
FROM aktor a
JOIN film_aktor fa ON a.aktor_id = fa.aktor_id
WHERE a.aktor_id IN (
    SELECT aktor_id
    FROM (
        SELECT aktor_id, COUNT(film_id) AS ile_filmow
        FROM film_aktor
        GROUP BY aktor_id
        HAVING COUNT(film_id) > 20
    ) AS aktywni_aktorzy
)
GROUP BY a.aktor_id, a.imie, a.nazwisko;

-- 9
SELECT f.tytul, f.film_id
FROM film f
WHERE f.film_id IN (
    SELECT fc.film_id
    FROM film_kategoria fc
    WHERE fc.kategoria_id = (
        SELECT kategoria_id
        FROM kategoria
        WHERE nazwa = 'Akcja'
    )
);

-- 10
SELECT k.imie, k.nazwisko, kr.kraj
FROM klient k
JOIN adres a ON k.adres_id = a.adres_id
JOIN miasto m ON a.miasto_id = m.miasto_id
JOIN kraj kr ON m.kraj_id = kr.kraj_id
JOIN (
    SELECT kraj_id
    FROM (
        SELECT kraj_id, COUNT(adres_id) AS ile
        FROM (
            SELECT a.adres_id, m.kraj_id
            FROM adres a
            JOIN miasto m ON a.miasto_id = m.miasto_id
        ) AS adresy_kraje
        GROUP BY kraj_id
        HAVING ile > 10
    ) AS popularne_kraje
) AS pk ON kr.kraj_id = pk.kraj_id;

-- 11
SELECT f.tytul, COUNT(w.wypozyczenie_id) AS liczba_wypozyczen
FROM film f
JOIN spis sp ON f.film_id = sp.film_id
JOIN wypozyczenie w ON sp.spis_id = w.spis_id
WHERE f.film_id IN (
    SELECT film_id
    FROM (
        SELECT s.film_id, COUNT(w.wypozyczenie_id) AS ile_razy
        FROM spis s
        JOIN wypozyczenie w ON s.spis_id = w.spis_id
        GROUP BY s.film_id
        HAVING ile_razy > 10
    ) AS popularne_filmy
)
GROUP BY f.film_id, f.tytul;

-- 12
SELECT f.tytul, SUM(p.kwota) AS suma_platnosci
FROM film f
JOIN spis s ON f.film_id = s.film_id
JOIN wypozyczenie w ON s.spis_id = w.spis_id
JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
WHERE f.film_id IN (
    SELECT film_id
    FROM (
        SELECT s.film_id, COUNT(w.wypozyczenie_id) AS ile
        FROM spis s
        JOIN wypozyczenie w ON s.spis_id = w.spis_id
        GROUP BY s.film_id
        HAVING ile > 10
    ) AS popularne
)
GROUP BY f.film_id, f.tytul;

-- 13
SELECT kategorie.nazwa, liczby.ile
FROM (
    SELECT kategoria_id, nazwa
    FROM kategoria
) AS kategorie
JOIN (
    SELECT kategoria_id, COUNT(film_id) AS ile
    FROM film_kategoria
    GROUP BY kategoria_id
) AS liczby ON kategorie.kategoria_id = liczby.kategoria_id;

-- 14
SELECT k.nazwa AS kategoria, SUM(p.kwota) AS suma_platnosci
FROM kategoria k
JOIN film_kategoria fk ON k.kategoria_id = fk.kategoria_id
JOIN film f ON fk.film_id = f.film_id
JOIN spis s ON f.film_id = s.film_id
JOIN wypozyczenie w ON s.spis_id = w.spis_id
JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
GROUP BY k.kategoria_id, k.nazwa;

-- 15
SELECT kr.kraj, k.nazwa AS kategoria, COUNT(DISTINCT f.film_id) AS liczba_filmow
FROM kraj kr
JOIN miasto m ON kr.kraj_id = m.kraj_id
JOIN adres a ON m.miasto_id = a.miasto_id
JOIN klient kl ON a.adres_id = kl.adres_id
JOIN wypozyczenie w ON kl.klient_id = w.klient_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
JOIN film_kategoria fk ON f.film_id = fk.film_id
JOIN kategoria k ON fk.kategoria_id = k.kategoria_id
GROUP BY kr.kraj_id, kr.kraj, k.kategoria_id, k.nazwa;

-- 16
SELECT kr.kraj, k.nazwa AS kategoria, SUM(p.kwota) AS suma_platnosci
FROM kraj kr
JOIN miasto m ON kr.kraj_id = m.kraj_id
JOIN adres a ON m.miasto_id = a.miasto_id
JOIN klient kl ON a.adres_id = kl.adres_id
JOIN platnosc p ON kl.klient_id = p.klient_id
JOIN wypozyczenie w ON p.wypozyczenie_id = w.wypozyczenie_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
JOIN film_kategoria fk ON f.film_id = fk.film_id
JOIN kategoria k ON fk.kategoria_id = k.kategoria_id
GROUP BY kr.kraj_id, kr.kraj, k.kategoria_id, k.nazwa;

-- 17
SELECT CONCAT(a.adres, ', ', a.okreg, ', ', m.miasto) AS pelny_adres_sklepu, kr.kraj, COUNT(w.wypozyczenie_id) AS liczba_wypozyczen
FROM sklep sk
JOIN adres a ON sk.adres_id = a.adres_id
JOIN miasto m ON a.miasto_id = m.miasto_id
JOIN kraj kr ON m.kraj_id = kr.kraj_id
JOIN spis s ON sk.sklep_id = s.sklep_id
JOIN wypozyczenie w ON s.spis_id = w.spis_id
GROUP BY sk.sklep_id, a.adres, a.okreg, m.miasto, kr.kraj;

-- 18
SELECT CONCAT(a.adres, ', ', a.okreg, ', ', m.miasto) AS pelny_adres_sklepu, kr.kraj, SUM(p.kwota) AS suma_platnosci
FROM sklep sk
JOIN adres a ON sk.adres_id = a.adres_id
JOIN miasto m ON a.miasto_id = m.miasto_id
JOIN kraj kr ON m.kraj_id = kr.kraj_id
JOIN spis s ON sk.sklep_id = s.sklep_id
JOIN wypozyczenie w ON s.spis_id = w.spis_id
JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
GROUP BY sk.sklep_id, a.adres, a.okreg, m.miasto, kr.kraj;

-- 19
SELECT k.nazwa AS kategoria, SUM(f.dlugosc) AS suma_dlugosci_minut
FROM kategoria k
JOIN film_kategoria fk ON k.kategoria_id = fk.kategoria_id
JOIN film f ON fk.film_id = f.film_id
GROUP BY k.kategoria_id, k.nazwa;

-- 20
SELECT CONCAT(kl.imie, ' ', kl.nazwisko) AS klient, CONCAT(a.imie, ' ', a.nazwisko) AS aktor, COUNT(DISTINCT w.wypozyczenie_id) AS liczba_obejrzan
FROM klient kl
JOIN wypozyczenie w ON kl.klient_id = w.klient_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
JOIN film_aktor fa ON f.film_id = fa.film_id
JOIN aktor a ON fa.aktor_id = a.aktor_id
GROUP BY kl.klient_id, kl.imie, kl.nazwisko, a.aktor_id, a.imie, a.nazwisko;

-- 21
SELECT CONCAT(k.imie, ' ', k.nazwisko) AS klient, f.ocena AS kategoria_wiekowa, COUNT(w.wypozyczenie_id) AS liczba_obejrzan
FROM klient k
JOIN wypozyczenie w ON k.klient_id = w.klient_id
JOIN spis s ON w.spis_id = s.spis_id
JOIN film f ON s.film_id = f.film_id
GROUP BY k.klient_id, k.imie, k.nazwisko, f.ocena;

-- 22
CREATE TABLE film_akcja LIKE film;

INSERT INTO film_akcja
SELECT f.*
FROM film f
WHERE f.film_id IN (
    SELECT fc.film_id
    FROM film_kategoria fc
    WHERE fc.kategoria_id = (
        SELECT kategoria_id
        FROM kategoria
        WHERE nazwa = 'Akcja'
    )
);

-- 23
UPDATE film_akcja
SET koszty_wymiany = (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp
)
WHERE koszty_wymiany < (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp2
);

-- 24
UPDATE film_akcja
SET koszty_wymiany = koszty_wymiany * 1.10
WHERE koszty_wymiany < (
    SELECT AVG(koszty_wymiany)
    FROM (SELECT koszty_wymiany FROM film_akcja) AS temp
);

-- 25
UPDATE film_akcja
SET stawka_wypozycz = stawka_wypozycz * 1.10
WHERE dlugosc > 120;

-- 26
UPDATE film_akcja
SET stawka_wypozycz = stawka_wypozycz * 0.80
WHERE film_id IN (
    SELECT DISTINCT fa.film_id
    FROM film_aktor fa
    JOIN aktor a ON fa.aktor_id = a.aktor_id
    WHERE (a.imie = 'JOHNNY' AND a.nazwisko = 'LOLLOBRIGIDA')
       OR (a.imie = 'ZERO' AND a.nazwisko = 'CAGE')
);

-- 27
UPDATE film_akcja fa
SET fa.stawka_wypozycz = fa.stawka_wypozycz * 1.20
WHERE fa.film_id IN (
    SELECT film_id
    FROM (
        SELECT f.film_id, SUM(p.kwota) AS suma_platnosci
        FROM film f
        JOIN film_kategoria fk ON f.film_id = fk.film_id
        JOIN kategoria k ON fk.kategoria_id = k.kategoria_id
        JOIN spis s ON f.film_id = s.film_id
        JOIN wypozyczenie w ON s.spis_id = w.spis_id
        JOIN platnosc p ON w.wypozyczenie_id = p.wypozyczenie_id
        WHERE k.nazwa = 'Akcja'
        GROUP BY f.film_id
        HAVING suma_platnosci > (
            SELECT AVG(sumy.suma)
            FROM (
                SELECT SUM(p2.kwota) AS suma
                FROM film f2
                JOIN film_kategoria fk2 ON f2.film_id = fk2.film_id
                JOIN kategoria k2 ON fk2.kategoria_id = k2.kategoria_id
                JOIN spis s2 ON f2.film_id = s2.film_id
                JOIN wypozyczenie w2 ON s2.spis_id = w2.spis_id
                JOIN platnosc p2 ON w2.wypozyczenie_id = p2.wypozyczenie_id
                WHERE k2.nazwa = 'Akcja'
                GROUP BY f2.film_id
            ) AS sumy
        )
    ) AS filmy_powyzej_sredniej
);

-- 28
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT DISTINCT fa.film_id
    FROM film_aktor fa
    JOIN aktor a ON fa.aktor_id = a.aktor_id
    WHERE a.imie = 'PENELOPE' AND a.nazwisko = 'GUINESS'
);

-- 29
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT film_id
    FROM (
        SELECT f.film_id, COUNT(w.wypozyczenie_id) AS liczba_wypozyczen
        FROM film f
        LEFT JOIN spis s ON f.film_id = s.film_id
        LEFT JOIN wypozyczenie w ON s.spis_id = w.spis_id
        GROUP BY f.film_id
        HAVING liczba_wypozyczen < 3
    ) AS rzadko_wypozyczane
);

-- 30
DELETE FROM film_akcja
WHERE film_id IN (
    SELECT film_id
    FROM film_opis
    WHERE opis LIKE '%Epic%'
);

-- 31
DELETE FROM film_akcja
WHERE ocena IN ('NC-17', 'PG');
